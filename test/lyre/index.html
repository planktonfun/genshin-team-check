<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, 
		width=device-width, height=device-height, target-densitydpi=device-dpi" />
	<meta charset="utf-8" />
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</script>
    <script src="./chunk.js"></script>
    <style type="text/css" media="screen">
    	textarea {
    		height: 120px;
    		width: 220px;
    	}
    	#canvas-object {
    		border: 1px solid grey;
    	}
    	#blah {
    		display: none;
    	}
    	#slider-zoom {
    		float: left;
    		width: 60px;
    	}

    	.hide {
    		display: none;
    	}

    	#canvas-outputarea {
    		border: solid 1px;
    	}

	    body {
	    	margin: 0;
	    }

    	#mobile-canvas {
    		/*width: 100%;*/
    		height: 100%;
    	}

		.mobile-view {
			top: 0;
			left: 0;
    		display: block;
    		width: 100%;
    		height: 100%;
			position: absolute;
    	}
    	.desktop-view {
    		display: none;
    	}

    	@media screen and (min-width: 767px) {
    		body {
		    	margin: 8px;
		    }

	    	.desktop-view {
	    		display: block;
	    	}
			.mobile-view {
	    		/*display: none;*/
	    		position: relative;
	    	}
    	}

    	@media screen and (min-width: 320px) and (max-width: 767px) and (orientation: portrait) {
			html {
			    transform: rotate(-90deg);
			    transform-origin: left top;
			    width: 100vh;
			    height: 100vw;
			    overflow-x: hidden;
			    position: absolute;
			    top: 100%;
			    left: 0;
			}
		}

    </style>
</head>
<body>
<div class="mobile-view">
	<!-- <canvas id="mobile-canvas" width="1680" height="1052"></canvas> -->
	<!-- <canvas id="mobile-canvas-2" width="1680" height="1052"></canvas> -->
	<script src="./mobile-canvas.js"></script>
</div>
<div class="desktop-view">
<div>
	<video id="recording-video" class="hide" controls></video>
	<audio id="recording-audio" class="hide" controls></audio>
	<a href="" id="recording-video-link" class="hide" download="video.mp4">video link</a>
	<a href="" id="recording-audio-link" class="hide" download="video.mp3">audio link</a>
</div>
<div>
  <input type="checkbox" id="mute" name="mute">
  <label for="mute">mute</label>
</div>
<div>
  <input type="checkbox" id="online-everyone" name="online">
  <label for="online-everyone">online-everyone <span class="online-status">connecting...</span></label>
</div>
<div>
  <input type="checkbox" id="online-other" name="online">
  <label for="online-other">online-other <span class="online-status">connecting...</span></label>
</div>
<div>
  <input type="checkbox" id="online-self" name="online">
  <label for="online-self">online-self <span class="online-status">connecting...</span></label>
</div>
	<pre>
Note:
You can play notes here 
just press any QWERTYUASDFGHJZXCVBNM within this web page.
(doesn't work with mobile and safar browsers)

Reading Keymaps:

Keyboard (QWERTY) Notation

e.g.	G | A DH G | A DH G | A Q

UPPERCASE		main melody
lowercase			bass/harmony

pipe |                pause
ellipses …            pause longer (about one bar)
spaced notes (e.g. A S D)    approx. one beat each
joined notes (e.g. ASD)            play quickly
brackets ()            play notes at the same time
curly brackets {}        play notes at the same time, but with a tiny delay between 
                notes (arpeggio)
hyphens -            grouping notes for readability; play as usual
tilde ~                wait half a beat before playing next note ("swing")
1. / 2.                play verse with 1. the first time,
                then repeat verse with 2. the second time
slashes // and arrow →            repeat the notes quickly and end on the note after the arrow
(e.g. Q//A → Q)                 (tremolo)

</pre>
<div> Orchestra:
	<input type="button" class="createvideo" value="create video"/>
	<input type="button" class="record" value="record video"/>
	<input type="button" class="recordStop" value="stop recording"/>
	<ul class="generated">
	</ul>
	<input type="button" id="play-sequence" value="play in sequence"/>
	<input type="button" id="play-all" value="play all"/>
	<input type="button" id="stop-all" value="stop all"/>
	<input type="button" id="add-more" value="add more"/>
	<input type="button" id="remove-last" value="remove last"/>
	<input type="button" id="playsongareanumbers" value="play by numbers"/>
	<input type="button" id="playsongareaspace" value="play by key press"/>
	<script>
		var o_index = 1;
		function addMore(textData, bpmData) {
			o_index++;
			$('.generated').append(`
				<li>
					<textarea id="songarea-${ o_index }">${textData}</textarea>
					bpm:<input type="number" id="tempo-${ o_index }" value="${bpmData}"/>
					<input type="button" class="playsongarea" pid="${ o_index }" value="play"/>
					<input type="button" class="stopplaying" pid="${ o_index }" value="stop"/>
					assign to video: <input type="text" class="assigned-${ o_index }" pid="${ o_index }" value=""/>
					letter exceptions: <input type="text" class="exceptions-${ o_index }" pid="${ o_index }" value=""/>
				</li>
			`);
		}

		$('#add-more').click(function(){ addMore("", 80); });
		$('#remove-last').click(function(){
			$('.generated li:last').remove();
		});

		$('#play-all').click(function(){
			$('.playsongarea').click();
			$('#playsongareaslow').click();
		});

		$('#stop-all').click(function(){
			$('#playsongareastop').click();
			$('.stopplaying').click();
		});
	</script>
</div>
<br>
Input:<br>
<textarea id="songarea"></textarea>
bpm: <input type="number" id="tempo" value="80"/>
<input type="button" id="playsongareaslow" value="play"/>
<input type="button" id="playsongareastop" value="stop"/>
<div>
	Output:<br>
	<textarea id="outputarea" readonly></textarea>
	Output 2:<br>
	<textarea id="outputarea-2" readonly></textarea>
	Output 3:<br>
	<textarea id="outputarea-3" readonly></textarea>
	<canvas id="canvas-outputarea"></canvas>
	<canvas id="canvas-hidden" style="display:none;"></canvas>
</div>
<div>
	transpiler:<br>
	<textarea id="transpiler"></textarea>
	<input type="button" id="transpile" value="transpile"/>
	<input type="button" id="transpile-partly" value="transpile-partly-pianoletternotes"/>
	<input type="button" id="transpile-numbers" value="transpile-numbers-playbynumbers"/>
	<input type="button" id="transpile-ps" value="transpile-ps"/>
	<input type="button" id="transpile-mobile" value="transpile-mobile"/>
</div>
<div>
	by music sheet image:<br>

	<div>
		<img id="guide" style="display: none;">
		<canvas id="canvas-object" width="500" height="200"></canvas>
	</div>

	<div id="slider-zoom">
		<p>
		  <label for="amount">zoom:</label>
		  <input type="text" id="amount" readonly style="border:0; color:#f6931f; font-weight:bold;">
		</p>
		<div id="slider-vertical"></div>
	</div>

	<form runat="server">
	  <input accept="image/*" type='file' id="imgInp" />
	  <img id="blah" src="#" alt="your image" />
	  <input type="button" id="read-line" value="read line"/>
	  <input type="button" id="read-canvas" value="read"/>
	  <input type="button" id="stop-canvas" value="stop"/>
	  <input type="button" id="left-canvas" value="left"/>
	  <input type="button" id="right-canvas" value="right"/>
	  <input type="button" id="up-canvas" value="up"/>
	  <input type="button" id="down-canvas" value="down"/>
	  <input type="button" id="step-canvas" value="step"/>
	  <input type="button" id="reset-canvas" value="reset"/>
	  <input type="button" id="toggle-guide" value="show/hide guide"/>
	</form>

	<script>

		var offset = {x:0, y:0, zoom:1};
		var showGuide = false;
		var canvas = document.getElementById('canvas-object'),
		context = canvas.getContext('2d');

		imgInp.onchange = evt => {
		  const [file] = imgInp.files
		  if (file) {
		    blah.src = URL.createObjectURL(file);
		    blah.onload = function() {
				offset = {x:0, y:0, zoom:1};
				updateCanvas();

				guide.src = chunk;
				guide.onload = () => { updateCanvas(); };
		    }
		  }
		}


		var stop = false;
		var saved_offset = "";
		var offset_limit = 0;
		function animate() {
			saved_offset = JSON.stringify(offset);
			offset_limit = -(blah.width*offset.zoom) + 100;
			animate_process();
		}

		function step() {
          updateCanvas(); // draw image at current position
		  readGuideLine();
		  offset.x -= 1;
		}

		function animate_process(){
		  step();
		  if(stop == true) {
		  	stop = false;
		  	resetter();
		  } else if (offset.x > offset_limit) {
		  	requestAnimationFrame(animate_process);        // loop

		  } else {
		  	resetter();
		  }
		}

		var dragging = {
			status: false,
			x: 0,
			y: 0,
		};
		function handleMouseDown(e) {
		    var mousePos = getMousePosition(canvas, e);
		    // console.log('mouse is down');
		    dragging.status = true;
		    dragging.x = mousePos.x - offset.x;
		    dragging.y = mousePos.y - offset.y;
		}
		function handleMouseUp(e) {
		    var mousePosUp = getMousePosition(canvas, e);
		    // console.log('mouse is up');
		    dragging.status = false;
		}
		function handleMouseOut(e) {
		    var mousePosUp = getMousePosition(canvas, e);
		    // console.log('mouse is out');
		    dragging.status = false;
		}

		function handleMouseMove(e) {
		    var mousePosMove = getMousePosition(canvas, e);
		    if(dragging.status) {
		    	finalx=mousePosMove.x-dragging.x;
		    	finaly=mousePosMove.y-dragging.y;

		    	offset.x = finalx;
		    	offset.y = finaly;

		    	updateCanvas();
		    }

		}

		var lastFound = {
			many: 0,
			position: {},
		};

		function checkNote(raw) {
			var st = Date.now();
			// var note = /0{7}\w+0{9}\w+0{10}\w+0{11}\w+0{11}\w+0{11}\w+0{10}\w+0{9}\w+0{6}/g;
			// var note = /([04]){7}\w+\1{9}\w+\1{10}\w+\1{11}/g;
			var note = /([04]){7}[^04]+\1{8}[^04]+\1{7}/g;

			var positions = Array.from(raw.matchAll(note)).map(match => match.index);

			if(positions.length == 0) {
				lastFound = {
					many: 0,
					position: {},
				};

				console.log(Date.now() - st);
				return false;
			}

			console.log('note detected');

			for (var i = positions.length - 1; i >= 0; i--) {
				var position = positions[i];

				if(lastFound.position[i] != undefined)
					if(Math.abs(position - lastFound.position[i]) > 30)
						$('#transpiler').val($('#transpiler').val() + position + ' ');
					else
						console.log('do nothing twat!');
				else
					$('#transpiler').val($('#transpiler').val() + position + ' ');

				lastFound.position[i] = position;
			}

			lastFound.many = positions.length;

			console.log(Date.now() - st);
			return true;
		}

		/*var reader = {
			min: {x: 94, y: 0},
			max: {x: 103, y: 200}
		};*/

		var reader = {
			min: {x: 0, y: 0},
			max: {x: 50, y: 50}
		};

		function readGuideLine() {

			var revert = false;

			if(showGuide) {
				revert = true;
				showGuide = false;
				updateCanvas();
			}

			var display = [];
			var intensities = [];
			var checkPoint = [];
			var colors = [];

			for (var i = reader.min.y; i < reader.max.y; i++) {
				var row = [];
				var intensitiesRow = [];
				for (var j = reader.min.x; j < reader.max.x; j++) {
		    		var c = context.getImageData(j, i, 1, 1).data;
		    		var intensity = (c[0]+c[1]+c[2])/3;
					var inseA = String(intensity).charAt(0)
					// row.push('%c ');
					intensitiesRow.push(inseA);
					row.push('%c' + inseA);
					colors.push('background: '+rgbToHex(c[0],c[1],c[2])+'; color: white;');
				}

				if( intensitiesRow.join('').match(/([04]){7}/g) != null ) {
					checkPoint.push(intensities.length);
				}

				intensities.push(intensitiesRow.join(''));
				display.push(row.join(''));
			}

			console.clear();
			console.log(display.join('\n'), ...colors);
			checkNote(intensities.join(''));

			if(revert) {
				showGuide = true;
				updateCanvas();
			}
		}

		function componentToHex(c) {
		  var hex = c.toString(16);
		  return hex.length == 1 ? "0" + hex : hex;
		}

		function rgbToHex(r, g, b) {
		  return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
		}

		function getMousePosition(canvas, e) {
		   var boundary = canvas.getBoundingClientRect();
		    return {
		      x: e.clientX - boundary.left,
		      y: e.clientY - boundary.top
		    };
		}

		function resetter()
		{
			console.log('resetting');
			offset = JSON.parse(saved_offset);
			updateCanvas();
		}

		function updateCanvas()
		{
			try {
				context.clearRect(0, 0, canvas.width, canvas.height);
				context.drawImage(blah, offset.x, offset.y, blah.width*offset.zoom, blah.height*offset.zoom);
			} catch(e) {
				console.log(e);
			}

			if(showGuide) context.drawImage(guide, 0, 0);
		}

		canvas.addEventListener('mousemove', handleMouseMove, false);
		canvas.addEventListener('mouseout', handleMouseOut, false);
		canvas.addEventListener('mousedown', handleMouseDown, false);
		canvas.addEventListener('mouseup', handleMouseUp, false);

		$( "#slider-vertical" ).slider({
	      orientation: "vertical",
	      range: "min",
	      min: 0,
	      max: 200,
	      value: 100,
	      slide: function( event, ui ) {
	      	offset.zoom = ui.value/100;
		    updateCanvas();
	        $( "#amount" ).val( ui.value );
	      }
	    });
	    $( "#amount" ).val( $( "#slider-vertical" ).slider( "value" ) );

	    $('#read-line').click(readGuideLine);
	    $('#step-canvas').click(step);
	    $('#stop-canvas').click(()=>{ stop=true; });
	    $('#left-canvas').click(()=>{ offset.x -= 1; updateCanvas(); });
	    $('#right-canvas').click(()=>{ offset.x += 1; updateCanvas(); });
	    $('#up-canvas').click(()=>{ offset.y -= 1; updateCanvas(); });
	    $('#down-canvas').click(()=>{ offset.y += 1; updateCanvas(); });
	    $('#read-canvas').click(()=> {animate(); } );
	    $('#reset-canvas').click(resetter);
	    $('#toggle-guide').click(()=>{ showGuide = !showGuide; updateCanvas(); });
	</script>
</div>
</div>
</body>
<script>
	var numResourcesLoaded = 0;
	var sounds = [];
	var totalResources = 0;

	function loadAll( ) { // Load all images

		// Sounds
		var container = [
			"a",
			"b",
			"c",
			"d",
			"e",
			"f",
			"g",
			"h",
			"j",
			"m",
			"n",
			"q",
			"r",
			"s",
			"t",
			"u",
			"v",
			"w",
			"x",
			"y",
			"z",
		];

		totalResources = container.length;

		$.each( container, function( index, value ) {
			loadSounds( value );
		});
	}

	function loadSounds( name ) {
		sounds[name] = new Audio("./mp3s/" + name + ".mp3");
		sounds[name].addEventListener('loadeddata', function(){ loadFunc( ); });
	}

	function loadFunc( ) {
		numResourcesLoaded += 1;

		if( numResourcesLoaded === totalResources ) {
			loadPercent = 100;
			console.log('loading complete');
		} else {
			loadPercent = (( numResourcesLoaded / totalResources ) * 100);
			console.log('loading... ' + loadPercent);
		}
	}

	$(function(){
		loadAll( );
		addMore(`
b sasnsx  s
b sasnsx
b sasnsx  s
b sasnsx
[bj] [sj][ah][sg][nd] s [xg] [sh] [bs] s asn s x
{bsj} [sj][ah][sg][nd] s [xg] [sh] [bs] g s asns x
[bj] j[sh]g[cd] s [ag] [sh] [bs] sasb s c s x s
[zj] j[sh]g[zd] s [xg] s [ch] s [bg] sasnsx  s
b sasnsx
[zw]cbmd [zw]cbmd
[ce]bmdg [ct]bmdg[xj]bmsmbxb[mh]s[mg]b
[xh]bnsgh {wty} tw[zj]cbmd zcb[mj][dh]g
[zd]c[nh]ad zcnad[xj]bmsg xbm[bj][nh][mg]
[xs] {bmg} [za] {bmg} [za]c[bg]adgqgdabc
zjq[xh]bn xg
{bg} sasnsx s
b sasnsxb sasnsx s
b sasnsx
`,80)
		addMore(`
QJQGFDSA[AN] [AV]QJ[QC]GFDSA[AX]
GQW[EA] E E[TD]QT E[WB]SFQJHJ
QJ[QC]BA G[GV]BQ T[TB]SGR
[EN]DH QJ[QX]NAQ
[WB]SF ER[EB] HGF[GZ]
A TY[TN]AFQ
VNAFQ W[EB]A QJ[QN]ADH
QW[QX]NAFG QJ[QZ]BAF D`, 90);
	addMore(`
b [sj] [ah] [qd] [js][mg][ah][zsj]ad [xsh] n

b [sj] [ah] [qd] [js][mg][ah][zsj]ad q[~xnsh]

w [bu]sjuyt[be]d[qt] y [wb]sj bdagn

[aw] [bu]sjuyt[be]d[qt] y [wb]s[jt]gw bg[~dq]j[js]h

[~xgu]bm[su][yb][tm][ze]c[dt]cay[wxm]bsgbszbagba

[~zju]bm[ua][yg][ta][ex]a[tg][~adgy][~bmst]
`,40);

	addMore(`
v a q g v a q f x2
c a q g c a q f x2
x a q g x a q f x2
c a q g c a q f x2

v a q (~gh) v a q f x2
c a q (~gh) c a q f x2
x a q (~gh) x a q f x2

x n q (~gh) x n q f
1.) z a q (~gh) z a q f
2.) c b q (~gh) c n q f

[tv]rq gfa trq gfa ytq gfa rwq gfq
[tc]rq gfa trq gfa ytq gfa rwq gfw
[tx]rq gfa trq gfa ytq gfa rwq gfq
[tc]rq gfa trq gfa ytq gfa rwq gfw

[tgv] [tg]rq [yh]rq [rf]wq
[tgc] [tg]rq [yh]rq [rf]wq
[tgx] [tg]rq [yh]rq [rf]wq
[tgc] [tg]rq [yh]rq [rf]wq

(~vnah) q t h q r h q t h q r...
(~cnah) q t h q r h q t h q r...
(~xnah) q t h q r h q t h q r...
(~cnah) q t h q r h q t h q r...

(~fghqr)
`,116);	addMore(`
h j [qf] q [qs] h[jg] j [js] h [qf] q [qs] h[jg] ..

gh[jd] j [ja] g[hf] h [ha] g [jg] j [ja] g[hf] ..

hj[qf] q [qs] h[jg] j [js] h [qf] q [qs]eh[jg] ..

ggh[jd] j [ja] g[hf] h [ha] g [jg] j [ja]eg[hf] ..

dhj[qf] qsqshj gj j shj [qf] qsqehj ..

ggh[jd] jajagh fh h agh [jg] jajegh ..

eyu[af] rsrsyu gu u syu [rf] rsreyu ..

ygy[ud] uauaty fy y aty [ug] uauety ..

dhj[qf] q q h[jg] j j h [qf] q q h[jg] ..

gh[jd] j j g[hf] h h hgh [jg] j jeg[hf]
`,80);




	});


</script>
<script>

	var keymap = {
	    "65": "a",
	    "66": "b",
	    "67": "c",
	    "68": "d",
	    "69": "e",
	    "70": "f",
	    "71": "g",
	    "72": "h",
	    "74": "j",
	    "77": "m",
	    "78": "n",
	    // "79": "o",
	    "81": "q",
	    "82": "r",
	    "83": "s",
	    "84": "t",
	    "85": "u",
	    "86": "v",
	    "87": "w",
	    "88": "x",
	    "89": "y",
	    "90": "z"
	};

	var timestart = Date.now();

	function pushPlay() {
		var timeleng = (Date.now() - timestart);
		console.log(waitforspace.keys[waitforspace.i], timeleng);
		playSound(waitforspace.keys[waitforspace.i]);

		if(timeleng > tempo)  {
			$('#outputarea').val($('#outputarea').val()+".".repeat(Math.floor(timeleng/tempo)));
		}
		$('#outputarea').val($('#outputarea').val()+waitforspace.keys[waitforspace.i]);

		var pasedMult = $('#outputarea').val().replace(/(\[)(\.+)/g, function(match, p1, p2, offset, string) {
			return [p2,p1].join('');
		});

		$('#outputarea').val(pasedMult);

		waitforspace.i++;
		if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
		timestart = Date.now();
	}


	function simulateKeyPress(e) {
	// addEvent(document, "keydown", function (e) {
	    // e = e || window.event;
	    if(waitforspace.enable) {
	    	var gatherFastKeys = false;
	    	if(waitforspace.keys[waitforspace.i] == "{") {
				gatherFastKeys = true;
		    	waitforspace.i++;
		    	if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
			}

			if(gatherFastKeys) {
				var gathered=[];
				while(gatherFastKeys) {
					if(waitforspace.keys[waitforspace.i] == "}") {
						gatherFastKeys = false;
		    			waitforspace.i++;
		    			if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
	    			} else {
	    				gathered.push(waitforspace.keys[waitforspace.i]);
		    			waitforspace.i++;
		    			if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
	    			}
				}

				console.log(gathered);
				var timeleng = (Date.now() - timestart);

				if(timeleng > tempo) {

					$('#outputarea').val($('#outputarea').val()+".".repeat(Math.floor(timeleng/tempo)));
				}

				$('#outputarea').val($('#outputarea').val()+'{'+gathered.join('')+'}');

				timestart = Date.now();

				(function(gathered){
					var i = 0;
					(function k(zerodelay, fastdelay){
						playSound(gathered[i]);
						i++;
		        		if(i < gathered.length) setTimeout(k, 50);
		        	})();
		        })(gathered);

		        return;
			}

	    	var gatherKeys = false;
	    	switch(waitforspace.keys[waitforspace.i]) {
				case "[":
				case "(":
					$('#outputarea').val($('#outputarea').val()+"[");
					gatherKeys = true;
		    		waitforspace.i++;
		    		if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
				break;
			}

			if(gatherKeys) {
				while(gatherKeys) {
					switch(waitforspace.keys[waitforspace.i]) {
						case "]":
						case ")":
							$('#outputarea').val($('#outputarea').val()+"]");
							gatherKeys = false;
		    				waitforspace.i++;
		    				if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
						break;
						default:
	    					pushPlay();
						break;
					}
				}

				return;
			}

    		pushPlay();

	    	return;
	    }
	    // use e.keyCode
	 	// var texta = document.getElementById("area").value;
	    console.log(e.keyCode, keymap[e.keyCode], (Date.now() - timestart));
	    if(keymap[e.keyCode] != undefined) {
	    	playSound(keymap[e.keyCode]);

	    	for (var i = 0; i < mobilePlayers.length; i++) {
	    		mobilePlayers[i].buttonPressed(keymap[e.keyCode]);
	    	}
	    }
	    timestart = Date.now();
	    // keymap[e.keyCode] = texta;
	    // document.getElementById("area").value = "";
	}
	// });

	function addEvent(element, eventName, callback) {
	    if (element.addEventListener) {
	        element.addEventListener(eventName, callback, false);
	    } else if (element.attachEvent) {
	        element.attachEvent("on" + eventName, callback);
	    } else {
	        element["on" + eventName] = callback;
	    }
	}
</script>
<script>
	/**
	 * A sound pool to use for the sound effects
	 */

	// Add cache you magnificent bastard
  var blobs = {};
  var buffers = {};
	let audioCtx = new AudioContext();

  function loadInitSound() {
  	for(var i in keymap) {
  		var id = keymap[i];

  		if(blobs[id] == undefined)
  			((id)=>{
					fetch("./mp3s/" + id + ".mp3")
					.then(function(response) {
							return response.blob()
					})
					.then(function(blob) {
							blobs[id]=URL.createObjectURL(response.blob());
					}).catch((e) => console.log(`cant cache file`));
  			})(id)

  		if(buffers[id] == undefined)
  			((id)=>{
					fetch("./mp3s/" + id + ".mp3")
					.then(async function(response) {

							let buffer = await response.arrayBuffer();

							buffers[id] = await audioCtx.decodeAudioData(buffer);
							return response.blob()
					}).catch((e) => console.log(`cant cache file`));
  			})(id)
  	}
  }

  loadInitSound();

	function playSound( id ) {

		if ($('#mute').prop('checked') == true)
			return;

		if(isRecording) {
			for (var i in pidPlayers) {
				recordSound(i, id)
			}
		}

		if(buffers[id] != undefined) {
			var source = audioCtx.createBufferSource(); // creates a sound source
		  source.buffer = buffers[id];                    // tell the source which sound to play
		  source.connect(audioCtx.destination);       // connect the source to the context's destination (the speakers)
		  source.start(0);
		  return;
		}

		if(blobs[id] == undefined)
			fetch("./mp3s/" + id + ".mp3")
			    .then(function(response) {return response.blob()})
			    .then(function(blob) {
			        blobs[id]=URL.createObjectURL(blob);
			        // blobs[id]=blob;
			}).catch((e) => console.log(`cant cache file`));

		if(blobs[id] == undefined)
			var jump_sound = new Audio("./mp3s/" + id + ".mp3");
		else
			var jump_sound = new Audio(blobs[id]);

		console.log('playing..' + id);
		jump_sound.play();

		setTimeout(function(jump_sound){
			jump_sound.currentSrc = null;
			jump_sound.removeAttribute('src');
			jump_sound.srcObject = null;
			jump_sound.remove();
		},1700,jump_sound); // used this constant instead because their duration is so long at least 4 sec each

	}

	function recordSound(mobId, id) {
			if(buffers[id] != undefined) {
				var source = pidPlayers[mobId].audioContext.createBufferSource(); // creates a sound source
			  source.buffer = buffers[id];                    // tell the source which sound to play
			  source.connect(pidPlayers[mobId].audioStream);       // connect the source to the context's destination (the speakers)
			  source.start(0);
			}
	}

	function recordMutedSound(mobId, id) {
			if(buffers[id] != undefined) {
				const gainNode = pidPlayers[mobId].audioContext.createGain();
				gainNode.gain.value = 0; // 0 volume
				var source = pidPlayers[mobId].audioContext.createBufferSource(); // creates a sound source
			  source.buffer = buffers[id];                    // tell the source which sound to play
			  source.connect(gainNode).connect(pidPlayers[mobId].audioStream);       // connect the source to the context's destination (the speakers)
			  source.start(0);
			}
	}
</script>
<script>
	var waitforspace = {
		enable: false,
		keys: [],
		i: 0,
	};

	var prefixMap = {
		"7": "+",
		"6": "+",
		"5": "+",
		"4": "",
		"3": "-",
		"2": "-",
		// "1": "-",
	};


	var bpm = $('#tempo').val()*1; //4/4
	var tempo = 60000/bpm/4;
	var delays = [tempo,tempo,(tempo/2)];
	var stopPlaying = false;

	function getTempo(ide) {
		var bpm = $(ide).val()*1;
		var tempo = 60000/bpm/4;
		return [tempo,tempo,(tempo/2)];
	}

	$('#tempo').change(function(){
		var bpm = $(this).val()*1;
		tempo = 60000/bpm/4;
		delays = [tempo,tempo,(tempo/2)];
	});
	$('#playsongareanumbers').on('click', function(){
		stopPlaying = true; 
		waitforspace.enable = false;
		setTimeout(playSongNumbers,1000);
	});
	$('#playsongareafast').on('click', function(){
		delays = [129,129,50];
		stopPlaying = true; 
		waitforspace.enable = false;
		setTimeout(playSong,1000);
	});
	$('#playsongareaslow').on('click', function(){
		stopPlaying = true; 
		waitforspace.enable = false;
		setTimeout(playSong,1000);
	});

	var players = {};

	$(document).on('click', '.playsongarea', async function(){
		if(players[$(this).attr('pid')] != undefined) players[$(this).attr('pid')].stop();

		var aids = $(`.assigned-${ $(this).attr('pid') }`).val().split(',');
		var exceptions = $(`.exceptions-${ $(this).attr('pid') }`).val().split(',');

		console.log(aids);

		players[$(this).attr('pid')] = new PlayerObject('#songarea-' + $(this).attr('pid'), getTempo('#tempo-' + $(this).attr('pid')), aids, exceptions);
		players[$(this).attr('pid')].play();
	});

	$('#play-sequence').click(async function(){
		var pids = [];
		$('.playsongarea').each(function(){
			pids.push($(this).attr('pid'));
		});

		for (var i = 0; i < pids.length; i++) {
			var pid = pids[i];

			if(players[pid] != undefined) players[pid].stop();

			var aids = $(`.assigned-${ pid }`).val().split(',');
			var exceptions = $(`.exceptions-${ pid }`).val().split(',');

			players[pid] = new PlayerObject('#songarea-' + pid, getTempo('#tempo-' + pid), aids, exceptions);
			await players[pid].play();
		}
	});

	$(document).on('click', '.stopplaying', function(){
		players[$(this).attr('pid')].stop();
	});
	$(document).on('click', '.createvideo', function(){
		createMobilePlayer();
	});

	$('#playsongareastop').on('click', function(){
		stopPlaying = true; 
		waitforspace.enable = false;
	});

	$('#playsongareaspace').on('click', function(){
		stopPlaying = true;
		waitforspace.enable = false;
		$('#outputarea').val('');
		setTimeout(waitForKey,1000);
	});

	$("#transpile-numbers").on('click', function(){
		var keys = $('#songarea').val()
		.toLowerCase()
		.replaceAll("↵", ' ')
		.replaceAll('\n\t\t', ' ')
		.replaceAll('\t\t', ' ')
		.replaceAll('\n', ' ')
		.replaceAll('  ', ' ')
		.replaceAll('-', '')
		.trim()
		.split(' ');

		var out = '';

		keytoplay = null;
		for (var i = 0; i < keys.length; i++) {
			var data = keys[i].split(/([0-9]+)/);
			var raw = {key: data[0], delay: data[1]};

			if(keytoplay != null)
				if(raw.delay > tempo) {
					out += keytoplay.key;
					out += ".".repeat(Math.floor(raw.delay/tempo)-1);
				} else if(raw.delay < tempo/2 && raw.delay >= 10) {
					out += keytoplay.key;
					out += '}';
				} else if(raw.delay < 10) {
					out += keytoplay.key;
					out += ']';
				} else {
					out += keytoplay.key;
				}

			keytoplay = {key: data[0], delay: data[1]*1};
		}

		var out = out.replace(/((\w\})+)/g, function(match, p1, offset, string) {
			return ['{',p1.replace(/\}/g,''),'}'].join('');
		});

		var out = out.replace(/((\w\])+)/g, function(match, p1, offset, string) {
			return ['[',p1.replace(/\]/g,''),']'].join('');
		});

		var out = out.replace(/(\[\w\]\w)/g, function(match, p1, offset, string) {
			return ['[',p1.replace(/[\[\]]/g,''),']'].join('');
		});

		var out = out.replace(/(\{\w\}\w)/g, function(match, p1, offset, string) {
			return ['{',p1.replace(/[\{\}]/g,''),'}'].join('');
		});

		var out = out.replace(/\[(\w)\1\]/g, function(match, p1, offset, string) {
			return p1;
		});

		var out = out.replace(/\[(\w)\]/g, function(match, p1, offset, string) {
			return p1;
		});


		$('#outputarea').val(out);
	});

	$('#transpile-partly').on('click', function(){
		// play at 120 bpm
		var data = $('#transpiler').val().trim();

		var bam = [];

		data = data.replace(/[RL]H\:/g,'');
		data = data.replace(/\-/g,'.').split("\n\n");
		for (var i = 0; i < data.length; i++) {
			var melody = data[i].trim().split("\n");
			var filter = [];
			for (var e = 0; e < melody.length; e++) {
				var prefix = melody[e].match(/(\d)\|/)[1];

				if(prefixMap[prefix] != undefined)
					filter.push({ prefix, data: melody[e].replace(/[\d\|]/g, '').split('') });
			}

			var combined = [];

			console.log({melody, filter});

			if(filter[0] != undefined)
				for (var j = 0; j < filter[0].data.length; j++) {
					var letters = [];
					var lettersUnique = {};
					for (var e = 0; e < filter.length; e++) {
						// console.log(filter[e].data);
						// console.log(prefixMap[filter[e].prefix], filter[e].data[j]);
						if(filter[e].data[j] != ".")
							if(prefixMap[filter[e].prefix] != undefined)
								if(lettersUnique[prefixMap[filter[e].prefix] + filter[e].data[j]] == undefined) {
									letters.push(prefixMap[filter[e].prefix] + filter[e].data[j]);
									lettersUnique[prefixMap[filter[e].prefix] + filter[e].data[j]] = 1;
								}
					}
					// console.log({letters});

					if(letters.length > 1)
						combined.push('['+letters.join('')+']');
					else if(letters.length > 0)
						combined.push(letters.join(''));
					else
						combined.push('.');
				}
			// console.log(combined.join(''));

			bam.push(combined.join(''));
		}

		var outA = bam.join("\n").replace(/[A-Z]/g, function (m) { return m + '#'; }).toUpperCase();
		var outC = outA.replace(/[\+\-]?[A-Z]#/g,'');
		var outB = outA.replace(/#/g,'b');

		$('#outputarea').val(transpile(outA));
		addMore(transpile(outA), 160);
		$('#outputarea-2').val(transpile(outB));
		addMore(transpile(outB), 160);
		$('#outputarea-3').val(transpile(outC));
		addMore(transpile(outC), 160);

	});
	$('#transpile').on('click', function(){ 
		var data = $('#transpiler').val().trim();
		var result = transpile(data);
		$('#outputarea').val(result);

	});

	function transpile(data) {

		var data = data.replace(/[\-\+]?[CDEFGAB][b#]?/g, function (m) {
		    return {

		    	'C#':'S',
		        'D#':'D',
		        'E#':'F',
		        'F#':'G',
		        'G#':'H',
		        'A#':'J',
		        'B#':'Q',
		        'C':'A',
		        'D':'S',
		        'E':'D',
		        'F':'F',
		        'G':'G',
		        'A':'H',
		        'B':'J',
		        'Cb':'A',
		        'Db':'S',
		        'Eb':'D',
		        'Fb':'F',
		        'Gb':'G',
		        'Ab':'H',
		        'Bb':'J',

		        '+C#':'W',
		        '+D#':'E',
		        '+E#':'R',
		        '+F#':'T',
		        '+G#':'Y',
		        '+A#':'U',
		        '+B#':'|',
		        '+C':'Q',
		        '+D':'W',
		        '+E':'E',
		        '+F':'R',
		        '+G':'T',
		        '+A':'Y',
		        '+B':'U',
		        '+Cb':'Q',
		        '+Db':'W',
		        '+Eb':'E',
		        '+Fb':'R',
		        '+Gb':'T',
		        '+Ab':'Y',
		        '+Bb':'U',

		        '-C#':'X',
		        '-D#':'C',
		        '-E#':'V',
		        '-F#':'B',
		        '-G#':'N',
		        '-A#':'M',
		        '-B#':'A',
		        '-C':'Z',
		        '-D':'X',
		        '-E':'C',
		        '-F':'V',
		        '-G':'B',
		        '-A':'N',
		        '-B':'M',
		        '-Cb':'Z',
		        '-Db':'X',
		        '-Eb':'C',
		        '-Fb':'V',
		        '-Gb':'B',
		        '-Ab':'N',
		        '-Bb':'M',
		    }[m];

		/*return {
		    	'C#':'D',
		        'D#':'F',
		        'E#':'G',
		        'F#':'H',
		        'G#':'J',
		        'A#':'Q',
		        'B#':'A',
		        'C':'S',
		        'D':'D',
		        'E':'F',
		        'F':'G',
		        'G':'H',
		        'A':'J',
		        'B':'A',
		        'Cb':'S',
		        'Db':'D',
		        'Eb':'F',
		        'Fb':'G',
		        'Gb':'H',
		        'Ab':'J',
		        'Bb':'W',
		        '+C#':'E',
		        '+D#':'R',
		        '+E#':'T',
		        '+F#':'Y',
		        '+G#':'U',
		        '+A#':'Q',
		        '+B#':'|',
		        '+C':'W',
		        '+D':'E',
		        '+E':'R',
		        '+F':'T',
		        '+G':'Y',
		        '+A':'U',
		        '+B':'Q',
		        '+Cb':'W',
		        '+Db':'E',
		        '+Eb':'R',
		        '+Fb':'T',
		        '+Gb':'Y',
		        '+Ab':'U',
		        '+Bb':'X',
		        '-C#':'C',
		        '-D#':'V',
		        '-E#':'B',
		        '-F#':'N',
		        '-G#':'M',
		        '-A#':'A',
		        '-B#':'Z',
		        '-C':'X',
		        '-D':'C',
		        '-E':'V',
		        '-F':'B',
		        '-G':'N',
		        '-A':'M',
		        '-B':'Z',
		        '-Cb':'X',
		        '-Db':'C',
		        '-Eb':'V',
		        '-Fb':'B',
		        '-Gb':'N',
		        '-Ab':'M',
		        '-Bb':'S',
		    }[m]; */
		});

		return data;
	};

	function waitForKey(){
		timestart = Date.now();
		waitforspace.enable = true;
		stopPlaying = false;
		// parse the multipliers
		var pasedMult = $('#songarea').val().replace(/([^\n]+)\s?x\s?(\d+)\n?/g, function(match, p1, p2, offset, string) {
			var temp = [];
			for (var i = 0; i < p2; i++) {
				temp.push(p1);
			}
			return temp.join('');
		});

		pasedMult = pasedMult.replace(/(\(\~)(\w+)(\))/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p2,'}'].join('');
		});

		pasedMult = pasedMult.replace(/\((\w)\/\/(\w)\s→\s([\w\(\)]+)/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p1,p2,p1,p2,p1,p2,p1,p2,'}',p3].join('');
		});

		console.log(pasedMult);

		var keys = pasedMult
		.toLowerCase()
		.replaceAll(/['\.,\|\s\-]+/g, '')
		.trim()
		.split('');
		console.log(keys);
		waitforspace.keys = keys;
		waitforspace.i = 0;
	}

	function playSongNumbers(){
		stopPlaying = false;
		var keys = $('#songarea').val()
		.toLowerCase()
		.replaceAll("↵", ' ')
		.replaceAll('\n\t\t', ' ')
		.replaceAll('\t\t', ' ')
		.replaceAll('\n', ' ')
		.replaceAll('  ', ' ')
		.replaceAll('-', '')
		.trim()
		.split(' ');

		(function(keys){
			var i = 0;
			var keytoplay = null;
		    (function k(keytoplay){

				var data = keys[i].split(/([0-9]+)/);

				console.log({key: data[0], delay: data[1]});

				if(keytoplay != null) {
					playSound(keytoplay);
		        	// var wdw = {key: keytoplay, delay: data[1]*1}
		        	// console.log({wdw});
				}

				if(stopPlaying == true) return;
				i++;
		        if(i < keys.length) {
		        	setTimeout(function(){ k(data[0]); }, data[1]*1);
		        }

		    })();
		})(keys);
	}

	function playSong() {
		// 260
		// 600
		stopPlaying = false;
		// parse the multipliers
		// var pasedMult = $(areaId).val().replace(/(\(\w+\)|\w|[ \w]+)x(\d+)\n/g, function(match, p1, p2, offset, string) {
		var pasedMult = $('#songarea').val().replace(/([^\n]+)\s?x\s?(\d+)\n?/g, function(match, p1, p2, offset, string) {
			var temp = [];
			for (var i = 0; i < p2; i++) {
				temp.push(p1);
			}
			return temp.join('');
		});

		pasedMult = pasedMult.replace(/([\(\[]\~)(\w+)([\]\)])/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p2,'}'].join('');
		});

		pasedMult = pasedMult.replace(/\((\w)\/\/(\w)\s→\s([\w\(\)]+)/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p1,p2,p1,p2,p1,p2,p1,p2,'}',p3].join('');
		});

		console.log(pasedMult);

		var keys = pasedMult
		.toLowerCase()
		.replaceAll("↵", ' ')
		.replaceAll('\n\t\t', ' ')
		.replaceAll('\t\t', ' ')
		.replaceAll('\n', ' ')
		.replaceAll('-', '')
		.replaceAll('  ', ' ')
		.trim()
		.split('');

		console.log(keys);

		(function(keys){
			var i = 0;
			var zerodelay = false;
			var fastdelay = false;
		    (function k(zerodelay, fastdelay){

		        switch(keys[i]) {
					case "{":
						fastdelay = true;
					break;
					case "}":
						fastdelay = false;
					break;
					case "[":
					case "(":
						zerodelay = true;
					break;
					case "]":
					case ")":
						zerodelay = false;
					break;
				}

				// console.log(keys[i],{zerodelay},{fastdelay});

				var delay = delays[0];
				if(fastdelay) delay = delays[2];
				if(zerodelay) delay = 10;

				switch(keys[i]) {
					case "~":
						delay = delays[1]/2;
					break;
					case "[":
					case "]":
					case "(":
					case ")":
					break;
					case ",":
					case ".":
					case "|":
					case "↵":
					case " ":
					case "\n":
					case "\t":
						delay = delays[1];
					break;
					default:
						playSound(keys[i]);
					break;
				}

				if(stopPlaying == true) return;
				i++;
		        if(i < keys.length) {
		        	setTimeout(()=>{k(zerodelay,fastdelay);}, delay );
		        }

		    })(zerodelay, fastdelay);
		})(keys);
	};

	var PlayerObject = function(areaId, delays, mobIds, mExceptions) {
		this.mobIds = mobIds;
		this.mExceptions = mExceptions;

		// record playing stuff
		isRecording = true;
		for (var j = 0; j < this.mobIds.length; j++) if(pidPlayers[this.mobIds[j]] != undefined) {
			pidPlayers[this.mobIds[j]].record();
		 	// to fix timing
		 	recordMutedSound(this.mobIds[j], 'q');
		}

		this.stop = function() {
			this.stopPlayingObj = true;
		};

		this.delays = JSON.parse(JSON.stringify(delays));
		console.log({delays});
		// parse the multipliers
		// var pasedMult = $(areaId).val().replace(/(\(\w+\)|\w|[ \w]+)x(\d+)\n/g, function(match, p1, p2, offset, string) {
		var pasedMult = $(areaId).val().replace(/([^\n]+)\s?x\s?(\d+)\n?/g, function(match, p1, p2, offset, string) {
			var temp = [];
			for (var i = 0; i < p2; i++) {
				temp.push(p1);
			}
			return temp.join('');
		});

		pasedMult = pasedMult.replace(/([\(\[]\~)(\w+)([\]\)])/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p2,'}'].join('');
		});

		pasedMult = pasedMult.replace(/\((\w)\/\/(\w)\s→\s([\w\(\)]+)/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p1,p2,p1,p2,p1,p2,p1,p2,'}',p3].join('');
		});

		console.log(pasedMult);

		this.keys = pasedMult
		.toLowerCase()
		.replaceAll("↵", ' ')
		.replaceAll('\n\t\t', ' ')
		.replaceAll('\t\t', ' ')
		.replaceAll('\n', ' ')
		.replaceAll('-', '')
		.replaceAll('  ', ' ')
		.trim()
		.split('');

		this.play = function() {
			return new Promise((resolve) => {
				(function(keys, parent) {
					var i = 0;
					var zerodelay = false;
					var fastdelay = false;
				    (function k(zerodelay, fastdelay){

				        switch(keys[i]) {
							case "{":
								fastdelay = true;
							break;
							case "}":
								fastdelay = false;
							break;
							case "[":
							case "(":
								zerodelay = true;
							break;
							case "]":
							case ")":
								zerodelay = false;
							break;
						}

						console.log(keys[i],{zerodelay},{fastdelay});

						var delay = parent.delays[0];
						if(fastdelay) delay = parent.delays[2];
						if(zerodelay) delay = 10;

						switch(keys[i]) {
							case "~":
								delay = delays[1]/2;
							break;
							case "[":
							case "]":
							case "(":
							case ")":
							break;
							case ",":
							case ".":
							case "|":
							case "↵":
							case " ":
							case "\n":
							case "\t":
								delay = parent.delays[1];
							break;
							default:

								// play multiple sound in multiple videos
								var hasPlayed = false;
								for (var j = 0; j < parent.mobIds.length; j++) {

									// allow only key in the video
									var allowKey = true;
									if(parent.mExceptions[j] != undefined) {
										if(parent.mExceptions[j].trim() != "") {
											var allowedLetters = new RegExp(`[${parent.mExceptions[j]}]`);

											if(!keys[i].match(allowedLetters)) {
												allowKey = false;
											}
										}
									}

									if(pidPlayers[parent.mobIds[j]] != undefined && allowKey == true) {
										pidPlayers[parent.mobIds[j]].buttonPressed(keys[i])
										hasPlayed = true;
										playSound(keys[i]);
									}
								}

								// play sound even if no video attached
								if(hasPlayed == false) {
									playSound(keys[i]);
								}


							break;
						}

						if(parent.stopPlayingObj == true) {
							// stop recording
							isRecording = false;
							for (var j = 0; j < parent.mobIds.length; j++) if(pidPlayers[parent.mobIds[j]] != undefined) pidPlayers[parent.mobIds[j]].stopRecord();

							parent.stopPlayingObj = false;
							resolve('done playing');
							return;
						}
						i++;
				        if(i < keys.length) {
				        	setTimeout(()=>{k(zerodelay,fastdelay);}, delay );
				        } else {
									// stop recording
									isRecording = false;
									for (var j = 0; j < parent.mobIds.length; j++) if(pidPlayers[parent.mobIds[j]] != undefined) pidPlayers[parent.mobIds[j]].stopRecord();

				        	console.log('done playing');
				        	resolve('done playing');
				        }

				    })(zerodelay, fastdelay);
				})(this.keys, this);
			});
		};
	};
</script>
<script>
	// r1 left up right down square triangle circle
	// left up right down square triangle circle
	// l1 left up right down square triangle circle

	var PS_Transpiler = function() {
		this.buttonsImg;
		this.PS_Mapping = {
			'Q': {x:279,y:114,w:49,h:49},
			'W': {x:215,y:107,w:49,h:49},
			'E': {x:405,y:108,w:49,h:49},
			'R': {x:344,y:117,w:49,h:49},
			'T': {x:153,y:105,w:46,h:44},
			'Y': {x:28,y:105,w:48,h:44},
			'U': {x:94,y:107,w:48,h:45},

			'A': {x:254,y:45,w:48,h:49},
			'S': {x:203,y:45,w:48,h:49},
			'D': {x:354,y:45,w:49,h:48},
			'F': {x:305,y:45,w:48,h:49},
			'G': {x:154,y:47,w:46,h:45},
			'H': {x:54,y:47,w:46,h:45},
			'J': {x:105,y:47,w:46,h:45},

			'Z': {x:267,y:231,w:49,h:50},
			'X': {x:219,y:186,w:50,h:50},
			'C': {x:410,y:187,w:50,h:49},
			'V': {x:332,y:187,w:48,h:49},
			'B': {x:149,y:169,w:46,h:45},
			'N': {x:40,y:181,w:47,h:45},
			'M': {x:96,y:212,w:47,h:45},
		};

		this.loadButtons = async function() {
			var that = this;
			return new Promise((resolve) => {
				that.buttonsImg = new Image();
				that.buttonsImg.src = "./buttons.png";
				that.buttonsImg.onload = function() { resolve(); };
			});
		}

		this.letterCanvas = document.getElementById("canvas-outputarea");
		this.letterContext = this.letterCanvas.getContext("2d");
		this.letterPositions = {x:0, y:0, row:0, rowLimit:5, max_x: 0, max_y: 0};
		this.letterRecordings = [];
		this.greyout = false;
		this.greycolor = '#d9d9d9';

		this.drawFromMapping = function(ctx, letter) {

			if(this.PS_Mapping[letter] != undefined) {
				if(this.greyout == true) {
					console.log('grey');
					ctx.beginPath();
					ctx.fillStyle = this.greycolor;
					ctx.fillRect(this.letterPositions.x,this.letterPositions.y, 50, 50);
				}

				ctx.drawImage(
					this.buttonsImg,
					this.PS_Mapping[letter].x,
					this.PS_Mapping[letter].y,
					this.PS_Mapping[letter].w,
					this.PS_Mapping[letter].h,
					this.letterPositions.x,
					this.letterPositions.y,
					this.PS_Mapping[letter].w,
					this.PS_Mapping[letter].h,
				);

			}

			this.letterPositions.x += 50;

			if(this.letterPositions.x > this.letterPositions.max_x)
				this.letterPositions.max_x = this.letterPositions.x;
		}

		this.newLetterLine = function() {
			this.letterPositions.x = 0;
			this.letterPositions.y += 50;

			if(this.letterPositions.y > this.letterPositions.max_y)
				this.letterPositions.max_y = this.letterPositions.y;
		}

		this.test = async function() {
			await this.loadButtons();

			for(var i in this.PS_Mapping) {
				this.letterRecordings.push(i);
				this.drawFromMapping(this.letterContext, i);

				this.letterPositions.row++;
				if(this.letterPositions.row == this.letterPositions.rowLimit) {
					this.letterPositions.row = 0;

					this.letterRecordings.push("\n");
					this.newLetterLine();
				}
			}

			this.end();
		}

		this.start = async function(listOfLetters) {
			await this.loadButtons();

			for (var i = 0; i < listOfLetters.length; i++) {

				if(listOfLetters[i] == "[") {
					this.letterRecordings.push(listOfLetters[i]);
					this.greyout = true;
				} else if(listOfLetters[i] == "]") {
					this.letterRecordings.push(listOfLetters[i]);
				    this.greyout = false;
				    this.letterPositions.x += 3;
				} else if(listOfLetters[i] == "(") {
					this.letterRecordings.push(listOfLetters[i]);
				    this.greyout = true;
				} else if(listOfLetters[i] == ")") {
					this.letterRecordings.push(listOfLetters[i]);
				    this.greyout = false;
				    this.letterPositions.x += 3;
				} else if(listOfLetters[i] == "\n") {
					this.letterRecordings.push("\n");
					this.newLetterLine();
				}
				else {
					this.letterRecordings.push(listOfLetters[i]);
					this.drawFromMapping(this.letterContext, listOfLetters[i]);
				}
			}

			this.end();
		}

		this.end = function() {
			this.letterCanvas.width = this.letterPositions.max_x;
			this.letterCanvas.height = this.letterPositions.max_y+50;
			this.letterPositions = {x:0, y:0};

			this.letterContext = this.letterCanvas.getContext("2d");
			this.letterContext.fillStyle = "white";
			this.letterContext.fillRect(0, 0, this.letterCanvas.width, this.letterCanvas.height);
			this.greyout = false;

			for (var i = 0; i < this.letterRecordings.length; i++) {
				if(this.letterRecordings[i] == "[") {
					this.greyout = true;
				} else if(this.letterRecordings[i] == "]") {
				    this.greyout = false;
				    this.letterPositions.x += 3;
				} else if(this.letterRecordings[i] == "(") {
				    this.greyout = true;
				} else if(this.letterRecordings[i] == ")") {
				    this.greyout = false;
				    this.letterPositions.x += 3;
				} else if(this.letterRecordings[i]=="\n") this.newLetterLine();
				else this.drawFromMapping(this.letterContext, this.letterRecordings[i]);
			}
		}
	}

	$('#transpile-ps').on('click', function(){
		var pasedMult = $('#transpiler').val().replace(/([^\n]+)\s?x\s?(\d+)\n?/g, function(match, p1, p2, offset, string) {
			var temp = [];
			for (var i = 0; i < p2; i++) {
				temp.push(p1);
			}
			return temp.join('');
		});

		pasedMult = pasedMult.replace(/([\(\[]\~)(\w+)([\]\)])/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p2,'}'].join('');
		});

		pasedMult = pasedMult.replace(/\((\w)\/\/(\w)\s→\s([\w\(\)]+)/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p1,p2,p1,p2,p1,p2,p1,p2,'}',p3].join('');
		});

		console.log(pasedMult);

		keys = pasedMult
		.toUpperCase()
		.replace(/↵/g, ' ')
		.replace(/\t\t/g, ' ')
		.replace(/-/g, '')
		.replace(/  /g, ' ')
		.trim()
		.split('');

		var a = new PS_Transpiler();

		// a.test();
		a.start(keys);
	});

	$("#recording-video")[0].addEventListener('play', (event) => {
	  $("#recording-audio")[0].play();
	});

	$("#recording-video")[0].addEventListener('pause', (event) => {
	  $("#recording-audio")[0].pause();
	});

	let isRecording = false;
	$(".record").on('click', function(){
		isRecording = true;
		for(var i in pidPlayers) {
			pidPlayers[i].record();
			// fix timing
			recordMutedSound(i, 'q');
		}
	});
	$(".recordStop").on('click', function(){
		isRecording = false;
		for(var i in pidPlayers) {
			pidPlayers[i].stopRecord();
		}
	});
</script>
<script src="./transpile-mobile.js"></script>
<script src="./online.js"></script>