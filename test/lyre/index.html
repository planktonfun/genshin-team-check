<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, 
		width=device-width, height=device-height, target-densitydpi=device-dpi" />
	<meta charset="utf-8" />
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
        crossorigin="anonymous"></script>
</head>
<body>
	<pre>
Note:
You can play notes here 
just press any QWERTYUASDFGHJZXCVBNM within this web page.
(doesn't work with mobile and safar browsers)

Reading Keymaps:

Keyboard (QWERTY) Notation

e.g.	G | A DH G | A DH G | A Q

UPPERCASE		main melody
lowercase			bass/harmony

pipe |				pause
ellipses …			pause longer (about one bar)
spaced notes (e.g. A S D)	approx. one beat each
joined notes (e.g. ASD)	play quickly
brackets ()			play notes at the same time
curly brackets {}		play notes at the same time, but with a tiny delay between 
				notes (arpeggio)
1. / 2.				play verse with 1. the first time,
				then repeat verse with 2. the second time
slashes // and arrow →	repeat the notes quickly and end on the note after the arrow (e.g. Q//A → Q) (tremolo)

Using the player:
Put melody in the text area and press the button play song fast or play song slow.

copy paste a melody in the text area or compose a melody on your own.

</pre>
	<textarea id="songarea">
v a q g v a q f v a q g v a q f c a q g c a q f c a q g c a q f

x a q g x a q f x a q g x a q f c a q g c a q f c a q g c a q f

v a q (~gh) v a q f v a q (~gh) v a q f c a q (~gh) c a q f c a q (~gh) c a q f

x a q (~gh) x a q f x a q (~gh) x a q f x n q (~gh) x n q f z a q (~gh) z a q f

x n q (~gh) x n q f c b q (~gh) c n q f

[tv]rq gfa trq gfa ytq gfa rwq gfq [tc]rq gfa trq gfa ytq gfa rwq gfw

[tx]rq gfa trq gfa ytq gfa rwq gfq [tc]rq gfa trq gfa ytq gfa rwq gfw

[tgv] [tg]rq [yh]rq [rf]wq [tgc] [tg]rq [yh]rq [rf]wq

[tgx] [tg]rq [yh]rq [rf]wq [tgc] [tg]rq [yh]rq [rf]wq

(~vnah) q t h q r h q t h q r... (~cnah) q t h q r h q t h q r...

(~xnah) q t h q r h q t h q r... (~cnah) q t h q r h q t h q r... 

(~fghqr)
	</textarea>
	bpm: <input type="number" id="tempo" value="116"/>
	<!-- <input type="button" id="playsongareafast" value="play song fast"/> -->
	<input type="button" id="playsongareaslow" value="play song (bpm timing)"/>
	<input type="button" id="playsongareanumbers" value="play song (number timing)"/>
	<input type="button" id="playsongareaspace" value="play song (keypress timing)"/>
	<input type="button" id="playsongareastop" value="stop playing"/>
	<textarea id="outputarea">
	</textarea>
</body>
<script>
	var numResourcesLoaded = 0;
	var sounds = [];
	var totalResources = 0;

	function loadAll( ) { // Load all images

		// Sounds
		var container = [
			"a",
			"b",
			"c",
			"d",
			"e",
			"f",
			"g",
			"h",
			"j",
			"m",
			"n",
			"q",
			"r",
			"s",
			"t",
			"u",
			"v",
			"w",
			"x",
			"y",
			"z",
		];

		totalResources = container.length;

		$.each( container, function( index, value ) {
			loadSounds( value );
		});
	}

	function loadSounds( name ) {
		sounds[name] = new Audio("./mp3s/" + name + ".mp3");
		sounds[name].addEventListener('loadeddata', function(){ loadFunc( ); });
	}

	function loadFunc( ) {
		numResourcesLoaded += 1;

		if( numResourcesLoaded === totalResources ) {
			loadPercent = 100;
			console.log('loading complete');
		} else {
			loadPercent = (( numResourcesLoaded / totalResources ) * 100);
			console.log('loading... ' + loadPercent);
		}
	}

	$(function(){
		loadAll( );
	});
</script>
<script>

	var keymap = {
	    "65": "a",
	    "66": "b",
	    "67": "c",
	    "68": "d",
	    "69": "e",
	    "70": "f",
	    "71": "g",
	    "72": "h",
	    "74": "j",
	    "77": "m",
	    "78": "n",
	    "79": "o",
	    "81": "q",
	    "82": "r",
	    "83": "s",
	    "84": "t",
	    "85": "u",
	    "86": "v",
	    "87": "w",
	    "88": "x",
	    "89": "y",
	    "90": "z"
	};

	var timestart = Date.now();

	function pushPlay() {
		var timeleng = (Date.now() - timestart);
		console.log(waitforspace.keys[waitforspace.i], timeleng);
		playSound(waitforspace.keys[waitforspace.i]);

		if(timeleng > tempo)  {
			$('#outputarea').val($('#outputarea').val()+".".repeat(Math.floor(timeleng/tempo)));
		}
		$('#outputarea').val($('#outputarea').val()+waitforspace.keys[waitforspace.i]);
		waitforspace.i++;
		if(waitforspace.i > waitforspace.keys.length) waitforspace.enable = false;
		timestart = Date.now();
	}

	addEvent(document, "keydown", function (e) {
	    e = e || window.event;

	    if(waitforspace.enable) {
	    	var gatherFastKeys = false;
	    	if(waitforspace.keys[waitforspace.i] == "{") {
				gatherFastKeys = true;
		    	waitforspace.i++;
		    	if(waitforspace.i > waitforspace.keys.length) waitforspace.enable = false;
			}

			if(gatherFastKeys) {
				var gathered=[];
				while(gatherFastKeys) {
					if(waitforspace.keys[waitforspace.i] == "}") {
						gatherFastKeys = false;
		    			waitforspace.i++;
		    			if(waitforspace.i > waitforspace.keys.length) waitforspace.enable = false;
	    			} else {
	    				gathered.push(waitforspace.keys[waitforspace.i]);
		    			waitforspace.i++;
		    			if(waitforspace.i > waitforspace.keys.length) waitforspace.enable = false;
	    			}
				}

				console.log(gathered);
				var timeleng = (Date.now() - timestart);

				if(timeleng > tempo) {

					$('#outputarea').val($('#outputarea').val()+".".repeat(Math.ceil(timeleng/tempo)));
				}

				$('#outputarea').val($('#outputarea').val()+'{'+gathered.join('')+'}');

				timestart = Date.now();

				(function(gathered){
					var i = 0;
					(function k(zerodelay, fastdelay){
						playSound(gathered[i]);
						i++;
		        		if(i < gathered.length) setTimeout(k, 50);
		        	})();
		        })(gathered);

		        return;
			}

	    	var gatherKeys = false;
	    	switch(waitforspace.keys[waitforspace.i]) {
				case "[":
				case "(":
					$('#outputarea').val($('#outputarea').val()+"[");
					gatherKeys = true;
		    		waitforspace.i++;
		    		if(waitforspace.i > waitforspace.keys.length) waitforspace.enable = false;
				break;
			}

			if(gatherKeys) {
				while(gatherKeys) {
					switch(waitforspace.keys[waitforspace.i]) {
						case "]":
						case ")":
							$('#outputarea').val($('#outputarea').val()+"]");
							gatherKeys = false;
		    				waitforspace.i++;
		    				if(waitforspace.i > waitforspace.keys.length) waitforspace.enable = false;
						break;
						default:
	    					pushPlay();
						break;
					}
				}

				return;
			}

    		pushPlay();

	    	return;
	    }
	    // use e.keyCode
	 	// var texta = document.getElementById("area").value;
	    console.log(e.keyCode, keymap[e.keyCode], (Date.now() - timestart));
	    if(keymap[e.keyCode] != undefined) playSound( keymap[e.keyCode] );
	    timestart = Date.now();
	    // keymap[e.keyCode] = texta;
	    // document.getElementById("area").value = "";
	});

	function addEvent(element, eventName, callback) {
	    if (element.addEventListener) {
	        element.addEventListener(eventName, callback, false);
	    } else if (element.attachEvent) {
	        element.attachEvent("on" + eventName, callback);
	    } else {
	        element["on" + eventName] = callback;
	    }
	}
</script>
<script>
	/**
	 * A sound pool to use for the sound effects
	 */

	function playSound( id ) {
		var jump_sound = new Audio("./mp3s/" + id + ".mp3");
		// jump_sound.volume = .12;
		jump_sound.play();

	}
</script>
<script>
	var waitforspace = {
		enable: false,
		keys: [],
		i: 0,
	};

	var bpm = $('#tempo').val()*1; //4/4
	var tempo = 60000/bpm/4;
	var delays = [tempo,tempo,(tempo/2)];
	var stopPlaying = false;

	$('#tempo').change(function(){
		var bpm = $(this).val()*1;
		tempo = 60000/bpm/4;
		delays = [tempo,tempo,(tempo/2)];
	});
	$('#playsongareanumbers').on('click', function(){
		stopPlaying = true; 
		waitforspace.enable = false;
		setTimeout(playSongNumbers,1000);
	});
	$('#playsongareafast').on('click', function(){
		delays = [129,129,50];
		stopPlaying = true; 
		waitforspace.enable = false;
		setTimeout(playSong,1000);
	});
	$('#playsongareaslow').on('click', function(){
		stopPlaying = true; 
		waitforspace.enable = false;
		setTimeout(playSong,1000);
	});
	$('#playsongareastop').on('click', function(){
		stopPlaying = true; 
		waitforspace.enable = false;
	});

	$('#playsongareaspace').on('click', function(){
		stopPlaying = true;
		waitforspace.enable = false;
		$('#outputarea').val('');
		setTimeout(waitForKey,1000);
	});

	function waitForKey(){
		waitforspace.enable = true;
		stopPlaying = false; 
		// parse the multipliers
		var pasedMult = $('#songarea').val().replace(/(\(\w+\)|\w|[ \w]+)x(\d+)/g, function(match, p1, p2, offset, string) {
			var temp = [];
			for (var i = 0; i < p2; i++) {
				temp.push(p1);
			}
			return temp.join('');
		});

		console.log(pasedMult);

		var keys = pasedMult
		.toLowerCase()
		.replaceAll(/['\.,\|\s]+/g, '')
		.trim()
		.split('');
		console.log(keys);
		waitforspace.keys = keys;
		waitforspace.i = 0;
	}

	function playSongNumbers(){
		stopPlaying = false; 
		var keys = $('#songarea').val()
		.toLowerCase()
		.replaceAll("↵", ' ')
		.replaceAll('\n\t\t', ' ')
		.replaceAll('\t\t', ' ')
		.replaceAll('\n', ' ')
		.replaceAll('  ', ' ')
		.trim()
		.split(' ');
		console.log(keys);

		(function(keys){
			var i = 0;
			var keytoplay = null;
		    (function k(keytoplay){

				var data = keys[i].split(/([0-9]+)/);

				console.log({key: data[0], delay: data[1]});

				if(keytoplay != null)
					playSound(keytoplay);

				if(stopPlaying == true) return;
				i++;
		        if(i < keys.length) {
		        	setTimeout(function(){ k(data[0]); }, data[1]*1);
		        }

		    })();
		})(keys);
	}

	function playSong(){
		// 260
		// 600
		stopPlaying = false; 
		// parse the multipliers
		var pasedMult = $('#songarea').val().replace(/(\(\w+\)|\w|[ \w]+)x(\d+)/g, function(match, p1, p2, offset, string) {
			var temp = [];
			for (var i = 0; i < p2; i++) {
				temp.push(p1);
			}
			return temp.join('');
		});

		pasedMult = pasedMult.replace(/(\(\~)(\w+)(\))/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p2,'}'].join('');
		});

		console.log(pasedMult);

		var keys = pasedMult
		.toLowerCase()
		.replaceAll("↵", ' ')
		.replaceAll('\n\t\t', ' ')
		.replaceAll('\t\t', ' ')
		.replaceAll('\n', ' ')
		.replaceAll('  ', ' ')
		.trim()
		.split('');

		console.log(keys);

		(function(keys){
			var i = 0;
			var zerodelay = false;
			var fastdelay = false;
		    (function k(zerodelay, fastdelay){

		        switch(keys[i]) {
					case "{":
						fastdelay = true;
					break;
					case "}":
						fastdelay = false;
					break;
					case "[":
					case "(":
						zerodelay = true;
					break;
					case "]":
					case ")":
						zerodelay = false;
					break;
				}

				console.log(keys[i],{zerodelay},{fastdelay});

				var delay = delays[0];
				if(fastdelay) delay = delays[2];
				if(zerodelay) delay = 10;

				switch(keys[i]) {
					case "[":
					case "]":
					case "(":
					case ")":
					break;
					case ",":
					case ".":
					case "|":
					case "↵":
					case " ":
					case "\n":
					case "\t":
						delay = delays[1];
					break;
					default:
						playSound(keys[i]);
					break;
				}

				if(stopPlaying == true) return;
				i++;
		        if(i < keys.length) {
		        	setTimeout(()=>{k(zerodelay,fastdelay);}, delay );
		        }

		    })(zerodelay, fastdelay);
		})(keys);
	};
</script>