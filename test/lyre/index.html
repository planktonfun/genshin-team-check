<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, 
		width=device-width, height=device-height, target-densitydpi=device-dpi" />
	<meta charset="utf-8" />
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
        crossorigin="anonymous"></script>
    <style type="text/css" media="screen">
    	textarea {
    		height: 120px;
    		width: 520px;
    	}
    </style>
</head>
<body>
<pre>
Note:
You can play notes here 
just press any QWERTYUASDFGHJZXCVBNM within this web page.
BPM is wonky, adjust it to make it sound right (dunno the maths to compute bpm)
(doesn't work with mobile and safar browsers)

Reading Keymaps:

Keyboard (QWERTY) Notation

e.g.	G | A DH G | A DH G | A Q

UPPERCASE                   main melody
lowercase                   bass/harmony

pipe |                      pause
ellipses …                  pause longer (about one bar)
spaced notes (e.g. A S D)   approx. one beat each
joined notes (e.g. ASD)     play quickly
brackets ()                 play notes at the same time
curly brackets {}           play notes at the same time, but with a tiny delay between 
                            notes (arpeggio)
hyphens -                   grouping notes for readability; play as usual
tilde ~                     wait half a beat before playing next note ("swing")
1. / 2.                     play verse with 1. the first time,
                            then repeat verse with 2. the second time
slashes // and arrow →      repeat the notes quickly and end on the note after the arrow
(e.g. Q//A → Q)             (tremolo)

</pre>

<div> Orchestra:
	<ul class="generated">
		<li>
			<textarea id="songarea">
[DN] {EEE} W Q [JB] Q W [JB] G  
[NC] {EEE} W Q [JB] Q T [EA]    
[NX] {EEE} W Q [JN] Q W [JB] G  
[HV] J Q Q [QN] J H [HC] [JMC] 

[DN] N {EE[EN]} W Q [JB] Q W [JB] G 
[NC] C {EE[EC]} W Q [JB] Q T [EA] W Q 
[SFN] N {EE[EN]} W Q [JB] Q W [JB] T 
[YSV] V V [RM] [TM] [YM] [UEC] [UEC] [UEC] [UEC] H J 

[QHV] V {VV} V V [GSB] B {QW[JS]} [HX] G  
[DN] N J [JN] C N [SB] [SB] [DN] G H J 
[QHV] V ({VV}) V V [GSB] B {QW[JS]} [HX] G 
[HND] N [EC] [EC] C [HN] [QA] [WS] [EN] 

[DN] {EEE} W Q [JB] Q W [JB] G 
C {WWW} Q J [JB] Q T [EA] W Q 
[SN] {HHH} D H [JC] Q W [JC] Q W [JN] {HG[DN]} 
E E E
[EDC] [WS] [QA] [HN] cbm [WS] [TG] [UJ] {nadh}
			</textarea>
			bpm: <input type="number" id="tempo" value="80"/>
			<input type="button" id="playsongareaslow" value="play"/>
			<input type="button" id="playsongareastop" value="stop"/>
		</li>
	</ul>
	<input type="button" id="add-more" value="add-more"/>
	<input type="button" id="remove-last" value="remove-last"/>
	<!-- <input type="button" id="playsongareanumbers" value="play by numbers"/> -->
	<!-- <input type="button" id="playsongareaspace" value="play by key press"/> -->
	<script>
		var o_index = 1;

		function addMore(textData, bpmData) {
			o_index++;
			$('.generated').append(`
				<li>
					<textarea id="songarea-${ o_index }">${textData}</textarea>
					bpm:<input type="number" id="tempo-${ o_index }" value="${bpmData}"/>
					<input type="button" class="playsongarea" pid="${ o_index }" value="play"/>
					<input type="button" class="stopplaying" pid="${ o_index }" value="stop"/>
				</li>
			`);
		}

		$('#add-more').click(function(){ addMore("", 80); });
		$('#remove-last').click(function(){
			$('.generated li:last').remove();
		});
	</script>
</div>
<br>
<!-- <div>
	Output:<br>
	<textarea id="outputarea" readonly></textarea>
</div> -->
</body>
<script>
	var numResourcesLoaded = 0;
	var sounds = [];
	var totalResources = 0;

	function loadAll( ) { // Load all images

		// Sounds
		var container = [
			"a",
			"b",
			"c",
			"d",
			"e",
			"f",
			"g",
			"h",
			"j",
			"m",
			"n",
			"q",
			"r",
			"s",
			"t",
			"u",
			"v",
			"w",
			"x",
			"y",
			"z",
		];

		totalResources = container.length;

		$.each( container, function( index, value ) {
			loadSounds( value );
		});
	}

	function loadSounds( name ) {
		sounds[name] = new Audio("./mp3s/" + name + ".mp3");
		sounds[name].addEventListener('loadeddata', function(){ loadFunc( ); });
	}

	function loadFunc( ) {
		numResourcesLoaded += 1;

		if( numResourcesLoaded === totalResources ) {
			loadPercent = 100;
			console.log('loading complete');
		} else {
			loadPercent = (( numResourcesLoaded / totalResources ) * 100);
			console.log('loading... ' + loadPercent);
		}
	}

	$(function(){
		loadAll( );

		addMore(`
W E {sfhwR} | R T {dgqE} | REW | Q (Hs)f (te) | {sfhwr}
W E (Rs)f (Eg) (Wf) (Wa)dgqet (Qd)

(sx)
(Nv) | (Nv) (Ab) (Nv) | (Bc) (Nv)
(Hfsn) (Hfsn) (Hfsn) (Qgda) (Hfsn) | (Gdb) (Fab)

xcxc-bnasd-nasdg-sdgh-we

(Mv) A N (Mv) | A N (Mv) | D | S A {MAM} N
(Mv) A N (Mv) | A N M (Av) | G

{DG(Hv)} ~v | (Jv) Q (Wv) ~v | {EW(Qv)}J(Qv) ~v | (Jv) H (Jv) ~vG v
(Hx) ~x | (Hx){(Qc)JH(Gv)} Fv F (Dv)b (Sn) ~n{SFG(Hn)}
HJQW(Egb) ~(Egb) ~(Egba)(Egns) (Edn)

(Hx)xns | nJ(Qs)(Wb)xms | {(Es)WQ}(Jb)(Qa)cma | c(Jm)(Ha)(Jx)xma(Gx)ma
(Hav) v v (Gv)F(Db) (Gb) (Qb) (Eb) (Wn) ~n ~n n

bvxsx(Ns)xsxs-(Mc)dcdcdcd
v(Av)v(Fv)(Hv)v(Qv)(Rv)-(Eb)bb{(rb)e(wb)j(gb)s(mb)s(fb)j(wb)}
(Fn) s | (Hf) f | (Js) {bnmsgj}((Wv)//S → (Wsv))
(Jm) (Jm) (Jm)

S D (Fv) ~v ~(Fv) G (Db) SbS A (Sn) nH n ~n ~n
S S (Db) (Fv) ~v ~(Fv) {GF(Db)} SbS A (Sn)adh ~n ~adh
(Um)sdh ~m ~sdh | (Yh) (Yh)`, 90);
	});
</script>
<script>

	var keymap = {
	    "65": "a",
	    "66": "b",
	    "67": "c",
	    "68": "d",
	    "69": "e",
	    "70": "f",
	    "71": "g",
	    "72": "h",
	    "74": "j",
	    "77": "m",
	    "78": "n",
	    "79": "o",
	    "81": "q",
	    "82": "r",
	    "83": "s",
	    "84": "t",
	    "85": "u",
	    "86": "v",
	    "87": "w",
	    "88": "x",
	    "89": "y",
	    "90": "z"
	};

	var timestart = Date.now();

	function pushPlay() {
		var timeleng = (Date.now() - timestart);
		console.log(waitforspace.keys[waitforspace.i], timeleng);
		playSound(waitforspace.keys[waitforspace.i]);

		if(timeleng > tempo)  {
			$('#outputarea').val($('#outputarea').val()+".".repeat(Math.floor(timeleng/tempo)));
		}
		$('#outputarea').val($('#outputarea').val()+waitforspace.keys[waitforspace.i]);

		var pasedMult = $('#outputarea').val().replace(/(\[)(\.+)/g, function(match, p1, p2, offset, string) {
			return [p2,p1].join('');
		});

		$('#outputarea').val(pasedMult);

		waitforspace.i++;
		if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
		timestart = Date.now();
	}

	addEvent(document, "keydown", function (e) {
	    e = e || window.event;

	    if(waitforspace.enable) {
	    	var gatherFastKeys = false;
	    	if(waitforspace.keys[waitforspace.i] == "{") {
				gatherFastKeys = true;
		    	waitforspace.i++;
		    	if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
			}

			if(gatherFastKeys) {
				var gathered=[];
				while(gatherFastKeys) {
					if(waitforspace.keys[waitforspace.i] == "}") {
						gatherFastKeys = false;
		    			waitforspace.i++;
		    			if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
	    			} else {
	    				gathered.push(waitforspace.keys[waitforspace.i]);
		    			waitforspace.i++;
		    			if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
	    			}
				}

				console.log(gathered);
				var timeleng = (Date.now() - timestart);

				if(timeleng > tempo) {

					$('#outputarea').val($('#outputarea').val()+".".repeat(Math.floor(timeleng/tempo)));
				}

				$('#outputarea').val($('#outputarea').val()+'{'+gathered.join('')+'}');

				timestart = Date.now();

				(function(gathered){
					var i = 0;
					(function k(zerodelay, fastdelay){
						playSound(gathered[i]);
						i++;
		        		if(i < gathered.length) setTimeout(k, 50);
		        	})();
		        })(gathered);

		        return;
			}

	    	var gatherKeys = false;
	    	switch(waitforspace.keys[waitforspace.i]) {
				case "[":
				case "(":
					$('#outputarea').val($('#outputarea').val()+"[");
					gatherKeys = true;
		    		waitforspace.i++;
		    		if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
				break;
			}

			if(gatherKeys) {
				while(gatherKeys) {
					switch(waitforspace.keys[waitforspace.i]) {
						case "]":
						case ")":
							$('#outputarea').val($('#outputarea').val()+"]");
							gatherKeys = false;
		    				waitforspace.i++;
		    				if(waitforspace.i >= waitforspace.keys.length) waitforspace.enable = false;
						break;
						default:
	    					pushPlay();
						break;
					}
				}

				return;
			}

    		pushPlay();

	    	return;
	    }
	    // use e.keyCode
	 	// var texta = document.getElementById("area").value;
	    console.log(e.keyCode, keymap[e.keyCode], (Date.now() - timestart));
	    if(keymap[e.keyCode] != undefined) playSound( keymap[e.keyCode] );
	    timestart = Date.now();
	    // keymap[e.keyCode] = texta;
	    // document.getElementById("area").value = "";
	});

	function addEvent(element, eventName, callback) {
	    if (element.addEventListener) {
	        element.addEventListener(eventName, callback, false);
	    } else if (element.attachEvent) {
	        element.attachEvent("on" + eventName, callback);
	    } else {
	        element["on" + eventName] = callback;
	    }
	}
</script>
<script>
	/**
	 * A sound pool to use for the sound effects
	 */

	function playSound( id ) {
		var jump_sound = new Audio("./mp3s/" + id + ".mp3");
		// jump_sound.volume = .12;
		jump_sound.play();

	}
</script>
<script>
	var waitforspace = {
		enable: false,
		keys: [],
		i: 0,
	};

	var bpm = $('#tempo').val()*1; //4/4
	var tempo = 60000/bpm/4;
	var delays = [tempo,tempo,(tempo/2)];
	var stopPlaying = false;

	function getTempo(ide) {
		var bpm = $(ide).val()*1;
		var tempo = 60000/bpm/4;
		return [tempo,tempo,(tempo/2)];
	}

	$('#tempo').change(function(){
		var bpm = $(this).val()*1;
		tempo = 60000/bpm/4;
		delays = [tempo,tempo,(tempo/2)];
	});
	$('#playsongareanumbers').on('click', function(){
		stopPlaying = true; 
		waitforspace.enable = false;
		setTimeout(playSongNumbers,1000);
	});
	$('#playsongareafast').on('click', function(){
		delays = [129,129,50];
		stopPlaying = true; 
		waitforspace.enable = false;
		setTimeout(playSong,1000);
	});
	$('#playsongareaslow').on('click', function(){
		stopPlaying = true; 
		waitforspace.enable = false;
		setTimeout(playSong,1000);
	});

	var players = {};

	$(document).on('click', '.playsongarea', function(){
		if(players[$(this).attr('pid')] != undefined) players[$(this).attr('pid')].stop();
		players[$(this).attr('pid')] = new PlayerObject('#songarea-' + $(this).attr('pid'), getTempo('#tempo-' + $(this).attr('pid')));
		players[$(this).attr('pid')].play();
	});
	$(document).on('click', '.stopplaying', function(){
		players[$(this).attr('pid')].stop();
	});

	$('#playsongareastop').on('click', function(){
		stopPlaying = true; 
		waitforspace.enable = false;
	});

	$('#playsongareaspace').on('click', function(){
		stopPlaying = true;
		waitforspace.enable = false;
		$('#outputarea').val('');
		setTimeout(waitForKey,1000);
	});

	function waitForKey(){
		timestart = Date.now();
		waitforspace.enable = true;
		stopPlaying = false;
		// parse the multipliers
		var pasedMult = $('#songarea').val().replace(/(\(\w+\)|\w|[ \w]+)x(\d+)/g, function(match, p1, p2, offset, string) {
			var temp = [];
			for (var i = 0; i < p2; i++) {
				temp.push(p1);
			}
			return temp.join('');
		});

		pasedMult = pasedMult.replace(/(\(\~)(\w+)(\))/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p2,'}'].join('');
		});

		pasedMult = pasedMult.replace(/\((\w)\/\/(\w)\s→\s([\w\(\)]+)/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p1,p2,p1,p2,p1,p2,p1,p2,'}',p3].join('');
		});

		console.log(pasedMult);

		var keys = pasedMult
		.toLowerCase()
		.replaceAll(/['\.,\|\s\-]+/g, '')
		.trim()
		.split('');
		console.log(keys);
		waitforspace.keys = keys;
		waitforspace.i = 0;
	}

	function playSongNumbers(){
		stopPlaying = false;
		var keys = $('#songarea').val()
		.toLowerCase()
		.replaceAll("↵", ' ')
		.replaceAll('\n\t\t', ' ')
		.replaceAll('\t\t', ' ')
		.replaceAll('\n', ' ')
		.replaceAll('  ', ' ')
		.replaceAll('-', '')
		.trim()
		.split(' ');

		(function(keys){
			var i = 0;
			var keytoplay = null;
		    (function k(keytoplay){

				var data = keys[i].split(/([0-9]+)/);

				console.log({key: data[0], delay: data[1]});

				if(keytoplay != null)
					playSound(keytoplay);

				if(stopPlaying == true) return;
				i++;
		        if(i < keys.length) {
		        	setTimeout(function(){ k(data[0]); }, data[1]*1);
		        }

		    })();
		})(keys);
	}

	function playSong() {
		// 260
		// 600
		stopPlaying = false; 
		// parse the multipliers
		var pasedMult = $('#songarea').val().replace(/(\(\w+\)|\w|[ \w]+)x(\d+)/g, function(match, p1, p2, offset, string) {
			var temp = [];
			for (var i = 0; i < p2; i++) {
				temp.push(p1);
			}
			return temp.join('');
		});

		pasedMult = pasedMult.replace(/(\(\~)(\w+)(\))/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p2,'}'].join('');
		});

		pasedMult = pasedMult.replace(/\((\w)\/\/(\w)\s→\s([\w\(\)]+)/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p1,p2,p1,p2,p1,p2,p1,p2,'}',p3].join('');
		});

		console.log(pasedMult);

		var keys = pasedMult
		.toLowerCase()
		.replaceAll("↵", ' ')
		.replaceAll('\n\t\t', ' ')
		.replaceAll('\t\t', ' ')
		.replaceAll('\n', ' ')
		.replaceAll('-', '')
		.replaceAll('  ', ' ')
		.trim()
		.split('');

		console.log(keys);

		(function(keys){
			var i = 0;
			var zerodelay = false;
			var fastdelay = false;
		    (function k(zerodelay, fastdelay){

		        switch(keys[i]) {
					case "{":
						fastdelay = true;
					break;
					case "}":
						fastdelay = false;
					break;
					case "[":
					case "(":
						zerodelay = true;
					break;
					case "]":
					case ")":
						zerodelay = false;
					break;
				}

				// console.log(keys[i],{zerodelay},{fastdelay});

				var delay = delays[0];
				if(fastdelay) delay = delays[2];
				if(zerodelay) delay = 10;

				switch(keys[i]) {
					case "~":
						delay = delays[1]/2;
					break;
					case "[":
					case "]":
					case "(":
					case ")":
					break;
					case ",":
					case ".":
					case "|":
					case "↵":
					case " ":
					case "\n":
					case "\t":
						delay = delays[1];
					break;
					default:
						playSound(keys[i]);
					break;
				}

				if(stopPlaying == true) return;
				i++;
		        if(i < keys.length) {
		        	setTimeout(()=>{k(zerodelay,fastdelay);}, delay );
		        }

		    })(zerodelay, fastdelay);
		})(keys);
	};

	var PlayerObject = function(areaId, delays) {
		this.stop = function() {
			this.stopPlayingObj = true;
		};

		this.delays = JSON.parse(JSON.stringify(delays));
		// parse the multipliers
		var pasedMult = $(areaId).val().replace(/(\(\w+\)|\w|[ \w]+)x(\d+)/g, function(match, p1, p2, offset, string) {
			var temp = [];
			for (var i = 0; i < p2; i++) {
				temp.push(p1);
			}
			return temp.join('');
		});

		pasedMult = pasedMult.replace(/(\(\~)(\w+)(\))/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p2,'}'].join('');
		});

		pasedMult = pasedMult.replace(/\((\w)\/\/(\w)\s→\s([\w\(\)]+)/g, function(match, p1, p2, p3, offset, string) {
			return ['{',p1,p2,p1,p2,p1,p2,p1,p2,'}',p3].join('');
		});

		// console.log(pasedMult);

		this.keys = pasedMult
		.toLowerCase()
		.replaceAll("↵", ' ')
		.replaceAll('\n\t\t', ' ')
		.replaceAll('\t\t', ' ')
		.replaceAll('\n', ' ')
		.replaceAll('-', '')
		.replaceAll('  ', ' ')
		.trim()
		.split('');

		this.play = function() {
			(function(keys, parent){
				var i = 0;
				var zerodelay = false;
				var fastdelay = false;
			    (function k(zerodelay, fastdelay){

			        switch(keys[i]) {
						case "{":
							fastdelay = true;
						break;
						case "}":
							fastdelay = false;
						break;
						case "[":
						case "(":
							zerodelay = true;
						break;
						case "]":
						case ")":
							zerodelay = false;
						break;
					}

					console.log(keys[i],{zerodelay},{fastdelay});

					var delay = parent.delays[0];
					if(fastdelay) delay = parent.delays[2];
					if(zerodelay) delay = 10;

					switch(keys[i]) {
						case "~":
							delay = delays[1]/2;
						break;
						case "[":
						case "]":
						case "(":
						case ")":
						break;
						case ",":
						case ".":
						case "|":
						case "↵":
						case " ":
						case "\n":
						case "\t":
							delay = parent.delays[1];
						break;
						default:
							playSound(keys[i]);
						break;
					}

					if(parent.stopPlayingObj == true) {
						parent.stopPlayingObj = false;
						return;
					}
					i++;
			        if(i < keys.length) {
			        	setTimeout(()=>{k(zerodelay,fastdelay);}, delay );
			        }

			    })(zerodelay, fastdelay);
			})(this.keys, this);
		};
	};
</script>